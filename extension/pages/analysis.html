<!doctype html>
<html lang="de">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>bahn.deals – Analyse</title>
  <link rel="stylesheet" href="../vendor/leaflet.css" />
  <link rel="stylesheet" href="../vendor/maplibre-gl.css" />
  <style>
    body {
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 16px;
      color: #111;
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      margin-bottom: 16px;
    }

    /* Main layout container */
    .main-container {
      display: grid;
      grid-template-columns: 1fr 500px;
      gap: 20px;
      align-items: start;
    }

    /* Responsive layout */
    @media (max-width: 1100px) {
      .main-container {
        grid-template-columns: 1fr;
      }

      .right-column {
        order: -1; /* Move map above analysis on mobile */
      }
    }

    .left-column {
      min-width: 0; /* Prevent grid blowout */
    }

    .right-column {
      position: sticky;
      top: 16px;
      max-height: calc(100vh - 32px);
    }

    .muted {
      color: #666;
    }

    .card {
      border: 1px solid #e1e1e1;
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: baseline;
      flex-wrap: wrap;
    }

    .route {
      font-weight: 600;
    }

    .lines {
      color: #333;
    }

    .progress {
      margin: 8px 0;
    }

    .small {
      font-size: 12px;
    }

    /* Button styling */
    #run {
      background: linear-gradient(135deg, #EC0016, #d40015);
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(236, 0, 22, 0.3);
    }

    #run:hover {
      background: linear-gradient(135deg, #d40015, #c00012);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(236, 0, 22, 0.4);
    }

    #run:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(236, 0, 22, 0.3);
    }

    #run:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Form controls styling */
    select,
    input[type="number"] {
      border: 2px solid #e1e1e1;
      border-radius: 4px;
      padding: 6px 8px;
      font-size: 14px;
      transition: border-color 0.2s ease;
    }

    select:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: #EC0016;
      box-shadow: 0 0 0 3px rgba(236, 0, 22, 0.1);
    }

    input[type="checkbox"] {
      accent-color: #EC0016;
    }

    /* Summary banner styling */
    #summary-banner {
      background: linear-gradient(135deg, #f0f8ff, #e6f3ff) !important;
      border: 2px solid #4a90e2 !important;
      border-radius: 12px !important;
      box-shadow: 0 4px 8px rgba(74, 144, 226, 0.1);
    }

    /* Options section styling */
    .options-section {
      background: linear-gradient(135deg, #fafafa, #f5f5f5);
      border: 1px solid #e1e1e1;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .options-title {
      font-weight: 600;
      color: #282d37;
      margin-bottom: 12px;
      font-size: 16px;
    }

    /* Map styling */
    #map-container {
      background: linear-gradient(135deg, #fafafa, #f5f5f5);
      border: 1px solid #e1e1e1;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    #map {
      flex: 1;
      min-height: 400px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 1100px) {
      #map-container {
        height: auto;
        margin-bottom: 16px;
      }

      #map {
        height: 400px;
        min-height: auto;
      }
    }

    /* Collapsible segments styling */
    .segment-group {
      margin-bottom: 12px;
      border: 1px solid #e1e1e1;
      border-radius: 6px;
      overflow: hidden;
    }

    .segment-header {
      background: linear-gradient(135deg, #f8f8f8, #f0f0f0);
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s ease;
    }

    .segment-header:hover {
      background: linear-gradient(135deg, #f0f0f0, #e8e8e8);
    }

    .segment-header::after {
      content: '▼';
      font-size: 12px;
      transition: transform 0.2s ease;
    }

    .segment-header.collapsed::after {
      transform: rotate(-90deg);
    }

    .segment-content {
      padding: 8px 16px;
      background: #fff;
    }

    .segment-content.collapsed {
      display: none;
    }

    .segment-content ul {
      margin: 4px 0;
      padding-left: 20px;
    }

    /* Copy button styling */
    .copy-button {
      background: #28a745;
      color: white;
      border: none;
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 8px;
      transition: background 0.2s ease;
    }

    .copy-button:hover {
      background: #218838;
    }

    /* Better progress log styling */
    #progress-log-container {
      margin-top: 12px;
    }

    #progress-log-header {
      font-size: 12px;
      color: #666;
      cursor: pointer;
      padding: 4px 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #progress-log-header::before {
      content: '▼';
      font-size: 10px;
      transition: transform 0.2s ease;
    }

    #progress-log-header.collapsed::before {
      transform: rotate(-90deg);
    }

    /* Journey info styling */
    .journey-info {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 8px;
      padding: 12px;
      background: linear-gradient(135deg, #f9f9f9, #f5f5f5);
      border-radius: 6px;
    }

    .journey-info-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .journey-info-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .journey-info-value {
      font-weight: 600;
      color: #282d37;
    }

    /* Help tooltips */
    .help-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      background: #666;
      color: white;
      border-radius: 50%;
      text-align: center;
      font-size: 11px;
      line-height: 16px;
      cursor: help;
      margin-left: 4px;
      position: relative;
    }

    .help-icon:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      font-weight: normal;
    }

    .help-icon:hover::before {
      content: '';
      position: absolute;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #333;
    }
  </style>
</head>

<body>
  <header>
    <div class="route" id="route">Analyse</div>
    <div class="muted small" id="meta"></div>
  </header>
  <div class="main-container">
    <div class="left-column">
      <section class="card">
    <div class="options-section">
      <div class="options-title">Reiseoptionen</div>
      <div class="row" style="gap:20px;flex-wrap:wrap;">
        <div>
          <label for="class-select" class="small muted">Klasse:</label>
          <select id="class-select" style="margin-left:6px;">
            <option value="2">2. Klasse</option>
            <option value="1">1. Klasse</option>
          </select>
        </div>
        <div>
          <label for="age-input" class="small muted">Alter:</label>
          <input type="number" id="age-input" min="0" max="120" value="30" style="width:60px;margin-left:6px;">
        </div>
        <div>
          <label for="bahncard-select" class="small muted">BahnCard:<span class="help-icon" data-tooltip="Ihre BahnCard für Rabatte">?</span></label>
          <select id="bahncard-select" style="margin-left:6px;">
            <option value="none">Keine</option>
            <option value="bc25">BahnCard 25</option>
            <option value="bc50">BahnCard 50</option>
            <option value="bc100">BahnCard 100</option>
          </select>
        </div>
        <div style="display:flex;align-items:center;">
          <label class="small muted" style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="dticket-check">
            Deutschlandticket
          </label>
        </div>
      </div>
    </div>
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div style="font-size:18px;font-weight:600;color:#282d37;">Analyse</div>
      <div><button id="run">Analyse starten</button></div>
    </div>
    <div id="summary-banner" class="card" style="background:#f0f8ff;border-color:#4a90e2;display:none;margin:12px 0;">
      <div style="margin-bottom:8px;"><strong>Aufteilungsanalyse</strong></div>
      <div class="row" style="gap:24px;flex-wrap:wrap;">
        <div>
          <div class="small muted">Originalpreis:</div>
          <div id="original-price" style="font-weight:600;">-</div>
        </div>
        <div>
          <div class="small muted">Beste Aufteilung:</div>
          <div id="best-split-price" style="font-weight:600;">-</div>
        </div>
        <div>
          <div class="small muted">Ersparnis:</div>
          <div id="savings" style="font-weight:600;color:#28a745;">-</div>
        </div>
      </div>
      <div id="chosen-segments" style="margin-top:8px;display:none;">
        <div class="small muted" style="margin-bottom:4px;">Gewählte Segmente:</div>
        <div id="chosen-segments-list" class="small"></div>
      <button class="copy-button" id="copy-segments" style="margin-top:8px;display:none;">Segmente kopieren</button>
      </div>
    </div>
    <div id="best-offer" class="row" style="gap:16px;align-items:center;display:none;">
      <div><strong>Günstigstes Angebot:</strong></div>
      <div id="best-offer-text"></div>
    </div>
    <div id="offers-list" style="margin-top:8px;display:none;">
      <div class="small muted" style="margin-bottom:4px;">Weitere Angebote:</div>
      <ul id="offers"></ul>
    </div>
    <div id="segments-list" style="margin-top:12px;display:none;">
      <div class="small muted" style="margin-bottom:8px;">Verfügbare Segmentpreise:</div>
      <div id="segments"></div>
    </div>
    <details style="margin-top:8px;">
      <summary class="small">Rohdaten</summary>
      <pre id="result" class="small" style="white-space:pre-wrap"></pre>
    </details>
  </section>
    </div>
    <div class="right-column">
      <section class="card" id="map-container" style="display:none;">
        <div class="options-title">Streckenübersicht</div>
        <div id="map"></div>
        <div id="map-info" class="small muted" style="margin-top:8px;"></div>
        <div class="small" style="margin-top:4px; color: #666; font-size: 11px;">
          <span style="color: #EC0016;">●</span> Start/Ziel (groß) •
          <span style="color: #EC0016;">●</span> Hauptbahnhöfe (klein) •
          <span style="color: #666;">●</span> Weitere Halte
        </div>
      </section>
      <section class="card" style="margin-top: 16px;">
        <div class="progress" id="progress">Warte auf Verbindungsdaten …</div>
        <div id="details" class="small"></div>
        <div id="progress-log-container">
          <div id="progress-log-header" class="small">Detaillierte Logs anzeigen</div>
          <div id="progress-log" class="small" style="max-height: 180px; overflow:auto; border-top:1px solid #eee; padding-top:8px; display:none;"></div>
        </div>
      </section>
    </div>
  </div>
  <script src="../vendor/leaflet.js"></script>
  <script src="../vendor/maplibre-gl.js"></script>
  <script src="../vendor/leaflet-maplibre-gl.js"></script>
  <script src="../common/messages.js"></script>
  <script type="module" src="analysis.js"></script>
</body>

</html>
